<%- include('navbar.ejs') %>

<% var adminData = admin || {};
   var profilePhoto = adminData.profile_image ? '/upload/admin/' + adminData.profile_image:'/images/default.png'; %>

<section class="profile-section">
  <div class="profile-card">

    <!-- ðŸ”¥ HEADER -->
<div class="profile-header text-center">

  <% if (adminData.profile_image) { %>

    <div class="profile-img-wrapper mx-auto">

      <!-- PROFILE IMAGE -->
      <img src="/upload/profile/<%= adminData.profile_image %>"
           class="profile-photo">

      <!-- DELETE ICON (BOTTOM OVERLAP) -->
      <form action="/admin/delete_profile_image" method="POST"
            onsubmit="return confirm('Delete profile photo?')">

        <button type="submit" class="delete-photo-btn">
          <i class="fas fa-trash"></i>
        </button>

      </form>

    </div>

  <% } else { %>

    <div class="profile-icon fs-5 mb-2">
      <i class="fas fa-user"></i>
    </div>

  <% } %>

  <h2>Admin Profile</h2>
  <p>Manage your account information</p>
</div>


    <!-- âœ… UPDATE FORM -->
    <form action="/admin/update_admin_profile" method="POST" enctype="multipart/form-data">
      <div class="row g-3">

        <div class="col-md-6">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-control"
                 name="admin_name"
                 value="<%= adminData.admin_name || '' %>" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">Email</label>
          <input type="email" name="admin_email" class="form-control"
                 value="<%= adminData.admin_email || '' %>" readonly>
        </div>

        <div class="col-md-6">
          <label class="form-label">Mobile</label>
          <input type="text" class="form-control"
                 name="admin_mobile"
                 value="<%= adminData.admin_mobile || '' %>" required>
        </div>

        <div class="col-md-6">
          <label class="form-label">New Password</label>
          <input type="password" class="form-control"
                 name="admin_password"
                 placeholder="Leave blank to keep old password">
        </div>

        <div class="col-md-12">
          <label class="form-label">Profile Photo</label>
          <input type="file" class="form-control"
                 name="profile_image"
                 id="photoInput"
                 accept="image/*">
          <input type="hidden" name="old_image"
                 value="<%= adminData.profile_image || '' %>">
        </div>

        <div class="col-md-12 mt-3">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-save me-2"></i> Update Profile
          </button>
        </div>

      </div>
    </form>

  </div>
</section>

<!-- ðŸ”¥ CROP MODAL -->
<div class="modal fade" id="cropModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Crop Profile Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="cropImage" style="max-width:100%;">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" id="cropSave">Crop & Save</button>
      </div>
    </div>
  </div>
</div>

<style>
.profile-section{
  min-height: 100vh;
  background: linear-gradient(135deg,#eef2ff,#f8fafc);
  padding: 40px 15px;
}
.profile-card{
  max-width: 850px;
  margin: auto;
  background: #fff;
  border-radius: 18px;
  padding: 35px;
  box-shadow: 0 15px 40px rgba(0,0,0,0.08);
}
.profile-header h2{
  font-weight: 700;
}
.profile-header p{
  color:#6c757d;
}
.profile-photo{
  width:120px;
  height:120px;
  border-radius:50%;
  object-fit:cover;
  font-size:60px;
  border:4px solid #4f46e5;
}

.profile-icon{
  width:120px;
  height:120px;
  border-radius:50%;
  background:#4f46e5;
  display:flex;
  align-items:center;
  justify-content:center;
  margin:0 auto;          /* ðŸ”¥ THIS is the key */
}

.profile-icon i{
  font-size:60px;
  color:#fff;
}

.profile-img-wrapper {
  position: relative;
  width: 130px;
  margin-bottom: 10px;
}

.profile-photo {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #fff;
}

/* DELETE ICON â€“ bottom right overlap */
.delete-photo-btn {
  position: absolute;
  bottom: 10px;      /* ðŸ‘ˆ ajun var */
  right: 13px;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border: none;
  background: white;
  color: black;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.35);
}


.delete-photo-btn:hover {
  background:black;
  color:white
}


</style>

    <script>
      let cropper;
      const input = document.getElementById('photoInput');
      const image = document.getElementById('cropImage');
      const modal = new bootstrap.Modal(document.getElementById('cropModal'));

      input.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
          image.src = reader.result;
          modal.show();

          if (cropper) cropper.destroy();

          cropper = new Cropper(image, {
            aspectRatio: 1, // square profile photo
            viewMode: 2,
            autoCropArea: 1
          });
        };
        reader.readAsDataURL(file);
      });

      document.getElementById('cropSave').addEventListener('click', function () {
        const canvas = cropper.getCroppedCanvas({
          width: 400,
          height: 500
        });

        canvas.toBlob(blob => {
          const file = new File([blob], "profile.jpg", { type: "image/jpeg" });

          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          input.files = dataTransfer.files;

          modal.hide();
        });
      });
    </script>

    <script>

      const params = new URLSearchParams(window.location.search);

        if (params.get("status") === "image_deleted") {
            alert("Profile image deleted successfully.");
            window.history.replaceState(
                {},
                document.title,
                window.location.pathname
            );
        }

        if (params.get("status") === "updated") {
            alert("Profile updated successfully.");
            window.history.replaceState(
                {},
                document.title,
                window.location.pathname
            );
        }

    </script>

<%- include('footer.ejs') %>