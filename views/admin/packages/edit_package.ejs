  <%- include("../navbar.ejs") %>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Summernote WYSIWYG Editor -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-lite.min.css" rel="stylesheet">
    
    <style>
        .card {
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 15px;
        }
        .form-label {
            font-weight: 600;
            color: #333;
        }
        .btn-submit {
            background: linear-gradient(45deg, #6a11cb 0%, #2575fc 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            color: white;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
        }
        .image-preview {
            width: 200px;
            height: 150px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: #f8f9fa;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        .feature-tag {
            display: inline-block;
            background: #e9ecef;
            padding: 5px 12px;
            border-radius: 20px;
            margin: 3px;
            font-size: 14px;
        }
        .feature-tag i {
            cursor: pointer;
            margin-left: 5px;
            color: #dc3545;
        }
        .container-fluid {
            min-height: calc(100vh - 200px); /* Adjust based on navbar/footer height */
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0"><i class="fas fa-edit me-2"></i>Edit Package</h4>
                        <a href="/admin/add_packages" class="btn btn-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i> Back to Packages
                        </a>
                    </div>
                    
                    <div class="card-body">
                        <form action="/admin/update_packages/<%= package.id %>" method="POST" enctype="multipart/form-data" id="editPackageForm">
                            <!-- Hidden field for package ID -->
                            <input type="hidden" name="package_id" value="<%= package.id %>">
                            
                            <div class="row">
                                <!-- Left Column -->
                                <div class="col-md-8">
                                    <!-- Basic Information -->
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">Basic Information</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="type" class="form-label">Package Type <span class="text-danger">*</span></label>
                                                    <select class="form-select" id="type" name="type" required>
                                                        <option value="">Select Type</option>
                                                        <option value="Basic" <%= package.type === 'Basic' ? 'selected' : '' %>>Basic</option>
                                                        <option value="Standard" <%= package.type === 'Standard' ? 'selected' : '' %>>Standard</option>
                                                        <option value="Premium" <%= package.type === 'Premium' ? 'selected' : '' %>>Premium</option>
                                                        <option value="Custom" <%= package.type === 'Custom' ? 'selected' : '' %>>Custom</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="col-md-6 mb-3">
                                                    <label for="package_name" class="form-label">Package Name <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="package_name" name="package_name" 
                                                           value="<%= package.package_name || '' %>" required>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="start_price" class="form-label">Starting Price <span class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">$</span>
                                                        <input type="number" class="form-control" id="start_price" name="start_price" 
                                                               step="0.01" min="0" value="<%= package.start_price || '' %>" required>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6 mb-3">
                                                    <label for="max_guests" class="form-label">Maximum Guests <span class="text-danger">*</span></label>
                                                    <input type="number" class="form-control" id="max_guests" name="max_guests" 
                                                           min="1" value="<%= package.max_guests || '' %>" required>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="service" class="form-label">Service Type</label>
                                                <input type="text" class="form-control" id="service" name="service" 
                                                       value="<%= package.service || '' %>" placeholder="e.g., Wedding, Birthday, Corporate">
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
                                                <textarea class="form-control" name="description" rows="5" required><%= package.description || '' %></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Features Included -->
                                    <div class="card mb-4">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">Features Included</h5>
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="addFeatureBtn">
                                                <i class="fas fa-plus me-1"></i> Add Feature
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <!-- Hidden input to store features as JSON -->
                                            <input type="hidden" id="feature_included" name="feature_included" 
                                                   value='<%= JSON.stringify(package.feature_included) || "[]" %> '>
                                            
                                            <!-- Feature tags display -->
                                            <div id="featuresContainer" class="mb-3">
                                                
                                                </div>
                                            
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="featureInput" 
                                                       placeholder="Enter a feature (e.g., DJ Service, Catering, Photography)">
                                                <button class="btn btn-primary" type="button" id="addFeatureInputBtn">
                                                    <i class="fas fa-plus"></i> Add
                                                </button>
                                            </div>
                                            <div class="form-text">Click 'Add' or press Enter to add features.</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Right Column -->
                                <div class="col-md-4">
                                    <!-- Image Upload -->
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">Package Image</h5>
                                        </div>
                                        <div class="card-body text-center">
                                            <div class="mb-3">
                                                <div class="image-preview mx-auto mb-3" id="imagePreview">
                                                    <% if (package.bg_image) { %>
                                                        <img src="/upload/packages/<%= package.bg_image %>" alt="Current Package Image" id="currentImage">
                                                    <% } else { %>
                                                        <div class="text-muted">
                                                            <i class="fas fa-image fa-3x"></i>
                                                            <p class="mt-2">No image selected</p>
                                                        </div>
                                                    <% } %>
                                                </div>
                                                <input type="file" class="form-control" id="bg_image" name="bg_image" 
                                                       accept="image/*" onchange="previewImage(event)">
                                                <div class="form-text">
                                                    Recommended size: 800x600px. Max 2MB. Allowed: JPG, PNG, GIF, WebP
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Support Options -->
                                    <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">Support Options</h5>
                                        </div>
                                        <div class="card-body">
                                            <!-- Parse support from JSON string if needed -->
                                            <% 
                                                let supportOptions = [];
                                                try {
                                                    supportOptions = Array.isArray(package.support) ? 
                                                        package.support : 
                                                        JSON.parse(package.support || '[]');
                                                } catch(e) {
                                                    supportOptions = [];
                                                }
                                            %>
                                            
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" name="support" value="24/7 Support" 
                                                       id="support1" <%= supportOptions.includes('24/7 Support') ? 'checked' : '' %>>
                                                <label class="form-check-label" for="support1">
                                                    24/7 Customer Support
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" name="support" value="Phone Support" 
                                                       id="support2" <%= supportOptions.includes('Phone Support') ? 'checked' : '' %>>
                                                <label class="form-check-label" for="support2">
                                                    Phone Support
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" name="support" value="Email Support" 
                                                       id="support3" <%= supportOptions.includes('Email Support') ? 'checked' : '' %>>
                                                <label class="form-check-label" for="support3">
                                                    Email Support
                                                </label>
                                            </div>
                                            <div class="form-check mb-2">
                                                <input class="form-check-input" type="checkbox" name="support" value="Live Chat" 
                                                       id="support4" <%= supportOptions.includes('Live Chat') ? 'checked' : '' %>>
                                                <label class="form-check-label" for="support4">
                                                    Live Chat Support
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="support" value="On-site Support" 
                                                       id="support5" <%= supportOptions.includes('On-site Support') ? 'checked' : '' %>>
                                                <label class="form-check-label" for="support5">
                                                    On-site Support
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Status -->
                                    <!-- <div class="card mb-4">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0">Package Status</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" role="switch" 
                                                       id="status" name="status" value="1" 
                                                       <%= package.status == 1 ? 'checked' : '' %>>
                                                <label class="form-check-label" for="status">
                                                    Active Package
                                                </label>
                                            </div>
                                            <div class="form-text">
                                                Inactive packages won't be visible to customers.
                                            </div>
                                        </div>
                                    </div> -->
                                    
                                    <!-- Submit Button -->
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-submit btn-lg">
                                            <i class="fas fa-save me-2"></i> Update Package
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" onclick="confirmDelete()">
                                            <i class="fas fa-trash me-2"></i> Delete Package
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this package?</p>
                    <p class="text-danger"><strong>Warning:</strong> This action cannot be undone!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash me-1"></i> Delete Package
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Summernote WYSIWYG Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.20/summernote-lite.min.js"></script>

    <script>
        // Initialize features array from hidden input
        let features = [];
        try {
            features = JSON.parse(document.getElementById('feature_included').value || '[]');
        } catch(e) {
            features = [];
        }
        
        // Render features as tags
        function renderFeatures() {
            const container = document.getElementById('featuresContainer');
            container.innerHTML = '';
            
            features.forEach((feature, index) => {
                const tag = document.createElement('span');
                tag.className = 'feature-tag';
                tag.innerHTML = `
                    ${feature}
                    <i class="fas fa-times" onclick="removeFeature(${index})"></i>
                `;
                container.appendChild(tag);
            });
            
            // Update hidden input
            document.getElementById('feature_included').value = JSON.stringify(features);
        }
        
        // Add feature from input
        function addFeature() {
            const input = document.getElementById('featureInput');
            const feature = input.value.trim();
            
            if (feature && !features.includes(feature)) {
                features.push(feature);
                renderFeatures();
                input.value = '';
            }
        }
        
        // Remove feature
        function removeFeature(index) {
            features.splice(index, 1);
            renderFeatures();
        }
        
        // Image preview function
        function previewImage(event) {
            const reader = new FileReader();
            const imagePreview = document.getElementById('imagePreview');
            
            reader.onload = function() {
                // Remove current image if exists
                const currentImage = document.getElementById('currentImage');
                if (currentImage) {
                    currentImage.remove();
                }
                
                // Remove default placeholder if exists
                const placeholder = imagePreview.querySelector('.text-muted');
                if (placeholder) {
                    placeholder.remove();
                }
                
                // Create and add new image
                const img = document.createElement('img');
                img.id = 'currentImage';
                img.src = reader.result;
                img.alt = 'Preview';
                imagePreview.appendChild(img);
            }
            
            if (event.target.files[0]) {
                reader.readAsDataURL(event.target.files[0]);
            }
        }
        
        // Delete confirmation
        function confirmDelete() {
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Render initial features
            renderFeatures();
            
            // Add feature button event
            document.getElementById('addFeatureInputBtn').addEventListener('click', addFeature);
            
            // Add feature on Enter key
            document.getElementById('featureInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addFeature();
                }
            });
            
            // Add feature from modal button
            document.getElementById('addFeatureBtn').addEventListener('click', function() {
                const newFeature = prompt('Enter a new feature:');
                if (newFeature && newFeature.trim() && !features.includes(newFeature.trim())) {
                    features.push(newFeature.trim());
                    renderFeatures();
                }
            });
            
            // Initialize Summernote editor for description
            $('#description').summernote({
                height: 200,
                toolbar: [
                    ['style', ['bold', 'italic', 'underline', 'clear']],
                    ['font', ['strikethrough', 'superscript', 'subscript']],
                    ['fontsize', ['fontsize']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['height', ['height']],
                    ['insert', ['link', 'picture', 'video']],
                    ['view', ['fullscreen', 'codeview', 'help']]
                ]
            });
            
            // Form validation
            document.getElementById('editPackageForm').addEventListener('submit', function(e) {
                const packageName = document.getElementById('package_name').value.trim();
                const startPrice = document.getElementById('start_price').value;
                
                if (!packageName) {
                    e.preventDefault();
                    alert('Please enter a package name');
                    document.getElementById('package_name').focus();
                    return;
                }
                
                if (!startPrice || parseFloat(startPrice) <= 0) {
                    e.preventDefault();
                    alert('Please enter a valid starting price');
                    document.getElementById('start_price').focus();
                    return;
                }
                
                // If everything is valid, show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Updating...';
                submitBtn.disabled = true;
            });
            
            // Delete button handler
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                // Redirect to delete route - adjust this route to match your server-side route
                window.location.href = `/admin/delet_packages/<%= package.id %>`;
            });
        });
    </script>
    
    <%- include("../footer.ejs") %>
</body>
</html>