
<%- include('../navbar.ejs') %>
<div class="dashboard-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <!-- Page Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="text-dark mb-0">
                            <i class="fas fa-edit me-2"></i>
                            Edit Package
                        </h2>
                        <p class="text-muted mb-0">Update package details</p>
                    </div>
                    <a href="/admin/add_packages" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Back to Packages
                    </a>
                </div>

                <!-- Form Card -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <form action="/admin/update_packages/<%= package.id %>" method="POST" enctype="multipart/form-data" id="editPackageForm">
                            <input type="hidden" name="package_id" value="<%= package.id %>">
                            
                            <div class="row">
                                <!-- Left Column (8 columns) -->
                                <div class="col-lg-8">
                                    <!-- Basic Information Card -->
                                    <div class="card mb-4 border-0 shadow-sm">
                                        <div class="card-header bg-light border-0">
                                            <h5 class="mb-0">
                                                <i class="fas fa-info-circle me-2"></i>
                                                Basic Information
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="type" class="form-label fw-semibold">
                                                        <i class="fas fa-tag me-1"></i> Package Type *
                                                    </label>
                                                    <select class="form-select" id="type" name="type" required>
                                                        <option value="">Select Type</option>
                                                        <option value="Basic" <%= package.type === 'Basic' ? 'selected' : '' %>>Basic</option>
                                                        <option value="Standard" <%= package.type === 'Standard' ? 'selected' : '' %>>Standard</option>
                                                        <option value="Premium" <%= package.type === 'Premium' ? 'selected' : '' %>>Premium</option>
                                                        <option value="VIP" <%= package.type === 'VIP' ? 'selected' : '' %>>VIP</option>
                                                        <option value="Custom" <%= package.type === 'Custom' ? 'selected' : '' %>>Custom</option>
                                                    </select>
                                                </div>
                                                
                                                <div class="col-md-6 mb-3">
                                                    <label for="package_name" class="form-label fw-semibold">
                                                        <i class="fas fa-box me-1"></i> Package Name *
                                                    </label>
                                                    <input type="text" class="form-control" id="package_name" name="package_name" 
                                                           value="<%= package.package_name || '' %>" placeholder="Enter package name" required>
                                                </div>
                                            </div>
                                            
                                            <div class="row">
                                                <div class="col-md-6 mb-3">
                                                    <label for="start_price" class="form-label fw-semibold">
                                                        <i class="fas fa-dollar-sign me-1"></i> Starting Price *
                                                    </label>
                                                    <div class="input-group">
                                                        <span class="input-group-text">â‚¹</span>
                                                        <input type="number" class="form-control" id="start_price" name="start_price" 
                                                               step="0.01" min="0" value="<%= package.start_price || '' %>" placeholder="0.00" required>
                                                    </div>
                                                </div>
                                                
                                                <div class="col-md-6 mb-3">
                                                    <label for="max_guests" class="form-label fw-semibold">
                                                        <i class="fas fa-users me-1"></i> Maximum Guests *
                                                    </label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="max_guests" name="max_guests" 
                                                               min="1" value="<%= package.max_guests || '' %>" placeholder="50" required>
                                                        <span class="input-group-text">guests</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="service" class="form-label fw-semibold">
                                                    <i class="fas fa-layer-group me-1"></i> Service Category
                                                </label>
                                                <select class="form-select" id="service" name="service">
                                                    <option value="">Select Service</option>
                                                    <option value="Wedding" <%= package.service === 'Wedding' ? 'selected' : '' %>>Wedding</option>
                                                    <option value="Corporate" <%= package.service === 'Corporate' ? 'selected' : '' %>>Corporate</option>
                                                    <option value="Birthday" <%= package.service === 'Birthday' ? 'selected' : '' %>>Birthday</option>
                                                    <option value="Conference" <%= package.service === 'Conference' ? 'selected' : '' %>>Conference</option>
                                                    <option value="Other" <%= package.service === 'Other' ? 'selected' : '' %>>Other</option>
                                                </select>
                                            </div>
                                            
                                            <div class="mb-3">
                                                <label for="description" class="form-label fw-semibold">
                                                    <i class="fas fa-align-left me-1"></i> Description *
                                                </label>
                                                <textarea class="form-control" id="description" name="description" rows="5" 
                                                          placeholder="Describe the package features and benefits..." required><%= package.description || '' %></textarea>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Features Included Card -->
                                    <div class="card mb-4 border-0 shadow-sm">
                                        <div class="card-header bg-light border-0">
                                            <h5 class="mb-0">
                                                <i class="fas fa-star me-2"></i>
                                                Features Included
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <input type="hidden" name="feature_included" id="feature_included" 
                                                   value='<%= JSON.stringify(package.feature_included || []) %>'>
                                            
                                            <div id="featuresContainer" class="d-flex flex-wrap gap-2 mb-3"></div>
                                            
                                            <div class="input-group">
                                                <input type="text" id="featureInput" class="form-control" 
                                                       placeholder="Add a new feature (e.g., Free Wi-Fi, Parking, etc.)">
                                                <button type="button" class="btn btn-outline-primary" onclick="addFeature()">
                                                    <i class="fas fa-plus me-1"></i> Add
                                                </button>
                                            </div>
                                            <small class="text-muted mt-1">Press Enter to add feature</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column (4 columns) -->
                                <div class="col-lg-4">
                                    <!-- Package Image Card -->
                                    <div class="card mb-4 border-0 shadow-sm">
                                        <div class="card-header bg-light border-0">
                                            <h5 class="mb-0">
                                                <i class="fas fa-image me-2"></i>
                                                Package Image
                                            </h5>
                                        </div>
                                        <div class="card-body text-center">
                                            <% if(package.bg_image){ %>
                                                <div class="mb-3">
                                                    <img src="/upload/packages/<%= package.bg_image %>" 
                                                         class="img-fluid rounded shadow-sm mb-3" 
                                                         style="max-height: 200px; width: auto;"
                                                         alt="Current package image">
                                                    <p class="text-muted small">Current Image</p>
                                                </div>
                                            <% } else { %>
                                                <div class="text-center py-4">
                                                    <i class="fas fa-image fa-3x text-muted mb-3"></i>
                                                    <p class="text-muted">No image uploaded</p>
                                                </div>
                                            <% } %>
                                            
                                            <div class="mt-3">
                                                <label for="bg_image" class="form-label fw-semibold">Upload New Image</label>
                                                <input type="file" class="form-control" id="bg_image" name="bg_image" accept="image/*">
                                                <small class="text-muted d-block mt-1">JPG, PNG, WebP (Max 10MB)</small>
                                                
                                                <div id="imagePreview" class="mt-3"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Support Options Card -->
                                    <div class="card mb-4 border-0 shadow-sm">
                                        <div class="card-header bg-light border-0">
                                            <h5 class="mb-0">
                                                <i class="fas fa-headset me-2"></i>
                                                Support Options
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <% 
                                                let support = [];
                                                if (package.support) {
                                                    if (Array.isArray(package.support)) {
                                                        support = package.support;
                                                    } else if (typeof package.support === 'string') {
                                                        try {
                                                            support = JSON.parse(package.support);
                                                        } catch (e) {
                                                            support = package.support.split(',');
                                                        }
                                                    }
                                                }
                                            %>
                                            
                                            <% const supportOptions = [
                                                { value: '24/7 Support', icon: 'fas fa-clock' },
                                                { value: 'Phone Support', icon: 'fas fa-phone' },
                                                { value: 'Email Support', icon: 'fas fa-envelope' },
                                                { value: 'Live Chat', icon: 'fas fa-comments' },
                                                { value: 'On-site Support', icon: 'fas fa-map-marker-alt' },
                                                { value: 'Dedicated Manager', icon: 'fas fa-user-tie' }
                                            ]; %>
                                            
                                            <% supportOptions.forEach(option => { %>
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" 
                                                           name="support" value="<%= option.value %>" 
                                                           id="support_<%= option.value.replace(/\s+/g, '_') %>"
                                                           <%= support.includes(option.value) ? 'checked' : '' %>>
                                                    <label class="form-check-label" for="support_<%= option.value.replace(/\s+/g, '_') %>">
                                                        <i class="<%= option.icon %> me-2"></i><%= option.value %>
                                                    </label>
                                                </div>
                                            <% }) %>
                                            
                                            <!-- Custom Support -->
                                            <div class="mt-4">
                                                <label class="form-label fw-semibold">Add Custom Support</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="customSupport" 
                                                           placeholder="Custom support option">
                                                    <button type="button" class="btn btn-outline-secondary" onclick="addCustomSupport()">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                                <div id="customSupportList" class="d-flex flex-wrap gap-2 mt-2"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Buttons Card -->
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-grid gap-3">
                                                <button type="submit" class="btn btn-success btn-lg">
                                                    <i class="fas fa-save me-2"></i> Update Package
                                                </button>
                                                
                                                <a href="/admin/delete_package/<%= package.id %>" 
                                                   class="btn btn-danger btn-lg"
                                                   onclick="return confirm('Are you sure you want to delete this package? This action cannot be undone.')">
                                                    <i class="fas fa-trash me-2"></i> Delete Package
                                                </a>
                                                
                                                <a href="/admin/add_packages" class="btn btn-outline-secondary">
                                                    <i class="fas fa-times me-2"></i> Cancel
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
// Initialize features array
let features = JSON.parse(document.getElementById('feature_included').value || '[]');

// Initialize custom supports array
let customSupports = [];

// Render features
function renderFeatures() {
    const container = document.getElementById('featuresContainer');
    container.innerHTML = '';
    
    features.forEach((feature, index) => {
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary d-inline-flex align-items-center me-2 mb-2';
        badge.innerHTML = `
            ${feature}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    onclick="removeFeature(${index})" 
                    style="font-size: 10px;"></button>
        `;
        container.appendChild(badge);
    });
    
    document.getElementById('feature_included').value = JSON.stringify(features);
}

// Add feature
function addFeature() {
    const input = document.getElementById('featureInput');
    const value = input.value.trim();
    
    if (value && !features.includes(value)) {
        features.push(value);
        input.value = '';
        renderFeatures();
        showToast('Feature added successfully!', 'success');
    }
}

// Remove feature
function removeFeature(index) {
    features.splice(index, 1);
    renderFeatures();
    showToast('Feature removed', 'warning');
}

// Add custom support
function addCustomSupport() {
    const input = document.getElementById('customSupport');
    const value = input.value.trim();
    const container = document.getElementById('customSupportList');
    
    if (value && !customSupports.includes(value)) {
        customSupports.push(value);
        
        const id = 'custom_' + Date.now();
        const badge = document.createElement('span');
        badge.className = 'badge bg-secondary d-inline-flex align-items-center me-2 mb-2';
        badge.innerHTML = `
            ${value}
            <button type="button" class="btn-close btn-close-white ms-2" 
                    onclick="removeCustomSupport('${id}')" 
                    style="font-size: 10px;"></button>
        `;
        container.appendChild(badge);
        
        // Add hidden input for custom support
        const inputField = document.createElement('input');
        inputField.type = 'hidden';
        inputField.name = 'support';
        inputField.value = value;
        inputField.id = id;
        container.appendChild(inputField);
        
        input.value = '';
        showToast('Custom support option added', 'success');
    }
}

// Remove custom support
function removeCustomSupport(id) {
    const element = document.getElementById(id);
    if (element) {
        element.remove();
    }
    const badge = document.querySelector(`[onclick="removeCustomSupport('${id}')"]`).parentElement;
    if (badge) {
        badge.remove();
    }
    showToast('Custom support removed', 'warning');
}

// Image preview
document.getElementById('bg_image').addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    if (this.files.length) {
        const file = this.files[0];
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'img-fluid rounded shadow-sm';
                img.style.maxHeight = '150px';
                preview.appendChild(img);
                
                const label = document.createElement('p');
                label.className = 'text-muted small mt-2';
                label.textContent = 'New image preview';
                preview.appendChild(label);
            };
            reader.readAsDataURL(file);
        }
    }
});

// Feature input Enter key
document.getElementById('featureInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addFeature();
    }
});

// Custom support input Enter key
document.getElementById('customSupport').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        addCustomSupport();
    }
});

// Form validation
document.getElementById('editPackageForm').addEventListener('submit', function(e) {
    // Validate features
    if (features.length === 0) {
        e.preventDefault();
        showToast('Please add at least one feature for the package', 'error');
        document.getElementById('featureInput').focus();
        return;
    }
    
    // Validate price
    const price = parseFloat(document.getElementById('start_price').value);
    if (price <= 0) {
        e.preventDefault();
        showToast('Please enter a valid price greater than 0', 'error');
        document.getElementById('start_price').focus();
        return;
    }
    
    // Show loading
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Updating...';
    submitBtn.disabled = true;
    
    // Re-enable after 5 seconds if still processing
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 5000);
});

// Toast notification
function showToast(message, type = 'success') {
    // You can use toastr library or create simple alert
    const alert = document.createElement('div');
    alert.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 1050;';
    alert.innerHTML = `
        <strong>${type === 'success' ? 'Success!' : 'Error!'}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 3000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    renderFeatures();
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
<%- include('../footer.ejs') %>